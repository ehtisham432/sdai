<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light min-vh-100">
    <div class="container py-5 px-2">
        <h1 class="display-5 fw-bold mb-4 text-center">Product Management</h1>
        <div class="card mb-4">
            <div class="card-body">
                <form id="productForm" class="row g-3 w-100 mx-auto" enctype="multipart/form-data">
                    <input type="hidden" id="productId">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold" for="name">Name</label>
                        <input type="text" id="name" class="form-control" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold" for="description">Description</label>
                        <input type="text" id="description" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-semibold" for="price">Price</label>
                        <input type="number" id="price" class="form-control" required min="0" step="0.01">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-semibold" for="companyId">Company</label>
                        <select id="companyId" class="form-select" required>
                            <option value="">Select Company</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-semibold" for="productCategoryId">Product Category</label>
                        <select id="productCategoryId" class="form-select">
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-semibold" for="productTypeId">Product Type</label>
                        <select id="productTypeId" class="form-select">
                            <option value="">Select Type</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-semibold" for="images">Product Images</label>
                        <input type="file" id="images" class="form-control" multiple accept="image/*">
                        <div id="imagePreview" class="d-flex flex-wrap gap-2 mt-2"></div>
                        <div class="form-text mt-2">Click a preview to mark it as the title image.</div>
                        <!-- Hidden field: selection value will be 'existing:<id>' or 'new:<idx>' -->
                        <input type="hidden" id="titleImageSelection">
                    </div>
                    <div class="col-12 d-flex justify-content-end gap-2 mt-2">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" id="resetBtn" class="btn btn-secondary">Reset</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <h2 class="h5 fw-bold mb-3">Products List</h2>
                <div class="row mb-3">
                    <div class="col-md-4 ms-auto">
                        <select id="filterCompanyId" class="form-select">
                            <option value="">All Companies</option>
                        </select>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Price</th>
                                <th>Company</th>
                                <th>Title Image</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTable">
                            <!-- Products will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script>
        const apiUrl = '/products';
        const companyApiUrl = '/companies';
        const productForm = document.getElementById('productForm');
        const productsTable = document.getElementById('productsTable');
        const resetBtn = document.getElementById('resetBtn');
        const companySelect = document.getElementById('companyId');
        const productCategorySelect = document.getElementById('productCategoryId');
    const productTypeSelect = document.getElementById('productTypeId');
        const filterCompanySelect = document.getElementById('filterCompanyId');

        function fetchCompanies() {
            fetch(companyApiUrl)
                .then(res => res.json())
                .then(companies => {
                    companySelect.innerHTML = '<option value="">Select Company</option>';
                    filterCompanySelect.innerHTML = '<option value="">All Companies</option>';
                    companies.forEach(company => {
                        companySelect.innerHTML += `<option value="${company.id}">${company.name}</option>`;
                        filterCompanySelect.innerHTML += `<option value="${company.id}">${company.name}</option>`;
                    });
                });
        }

        function fetchProductCategories() {
            fetch('/product-categories')
                .then(res => res.json())
                .then(categories => {
                    productCategorySelect.innerHTML = '<option value="">Select Category</option>';
                    categories.forEach(c => {
                        productCategorySelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                    });
                });
        }

        function fetchProductTypes() {
            fetch('/product-types')
                .then(res => res.json())
                .then(types => {
                    productTypeSelect.innerHTML = '<option value="">Select Type</option>';
                    types.forEach(t => {
                        productTypeSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`;
                    });
                });
        }

        function fetchProducts(companyId = '') {
            let url = apiUrl;
            if (companyId) url += `?companyId=${companyId}`;
            fetch(url)
                .then(res => res.json())
                .then(products => {
                    productsTable.innerHTML = '';
                    products.forEach(product => {
                        productsTable.innerHTML += `
                            <tr>
                                <td>${product.id}</td>
                                <td>${product.name}</td>
                                <td>${product.description}</td>
                                <td>${product.price}</td>
                                <td>${product.company ? product.company.name : ''}</td>
                                <td>${product.titleImageUrl ? `<img src='${product.titleImageUrl}' alt='Title Image' style='max-width:60px;max-height:60px;border-radius:6px;'>` : ''}</td>
                                <td class="d-flex gap-2">
                                    <button class="btn btn-warning btn-sm text-white" onclick="editProduct(${product.id})">Edit</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.id})">Delete</button>
                                </td>
                            </tr>
                        `;
                    });
                });
        }

        productForm.onsubmit = function(e) {
            e.preventDefault();
            const id = document.getElementById('productId').value;
            const name = document.getElementById('name').value;
            const description = document.getElementById('description').value;
            const price = document.getElementById('price').value;
            const companyId = document.getElementById('companyId').value;
            const productCategoryId = document.getElementById('productCategoryId').value;
            const productTypeId = document.getElementById('productTypeId').value;
            const imagesInput = document.getElementById('images');
            const selection = document.getElementById('titleImageSelection').value;
            const product = { name, description, price, company: { id: companyId }, productType: productTypeId ? { id: productTypeId } : null, productCategory: productCategoryId ? { id: productCategoryId } : null };
            if (id) product.id = id;
            let method = id ? 'PUT' : 'POST';
            let url = apiUrl + (id ? `/${id}` : '');
            const formData = new FormData();
            
            formData.append('product', new Blob([JSON.stringify(product)], { type: 'application/json' }));

            // if there are no files to upload, send a JSON PUT (avoids multipart parsing issues)
            if (imagesInput.files.length === 0) {
                // if user selected an existing image as title, include titleImageId as query param
                let putUrl = url;
                if (selection && selection.startsWith('existing:')) {
                    const idVal = selection.split(':')[1];
                    putUrl += `?titleImageId=${encodeURIComponent(idVal)}`;
                }
                // append imagesToDelete param if needed
                if (imagesToDelete.length > 0) {
                    const delParam = encodeURIComponent(JSON.stringify(imagesToDelete));
                    putUrl += (putUrl.includes('?') ? '&' : '?') + `imagesToDelete=${delParam}`;
                }
                fetch(putUrl, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(product)
                })
                .then(() => {
                    productForm.reset();
                    document.getElementById('productId').value = '';
                    document.getElementById('imagePreview').innerHTML = '';
                    document.getElementById('titleImageSelection').value = '';
                    existingImages = [];
                    selectedValue = null;
                    fetchProducts(filterCompanySelect.value);
                });
                return;
            }

            // append files for multipart request, skipping any new files the user removed
            for (let i = 0; i < imagesInput.files.length; i++) {
                if (deletedNewIndices.has(i)) continue;
                formData.append('images', imagesInput.files[i]);
            }

            // append title selection: existing:<id> or new:<idx>
            if (selection) {
                if (selection.startsWith('existing:')) {
                    const idVal = selection.split(':')[1];
                    formData.append('titleImageId', idVal);
                } else if (selection.startsWith('new:')) {
                    const idx = selection.split(':')[1];
                    formData.append('titleImageIdx', idx);
                }
            }
            // append imagesToDelete if any
            if (imagesToDelete.length > 0) {
                formData.append('imagesToDelete', JSON.stringify(imagesToDelete));
            }

            fetch(url, {
                method,
                body: formData
            })
            .then(() => {
                productForm.reset();
                document.getElementById('productId').value = '';
                document.getElementById('imagePreview').innerHTML = '';
                document.getElementById('titleImageSelection').value = '';
                existingImages = [];
                selectedValue = null;
                fetchProducts(filterCompanySelect.value);
            });
        };
        // Image preview and title selection logic
            const imagesInput = document.getElementById('images');
        const imagePreview = document.getElementById('imagePreview');
        const titleImageSelection = document.getElementById('titleImageSelection');

        // State holders
        let existingImages = []; // {id, url, titleImage}
        let selectedValue = null; // 'existing:<id>' or 'new:<idx>'
        let imagesToDelete = [];
        let deletedNewIndices = new Set();

        function setSelectedValue(val, domEl) {
            selectedValue = val;
            titleImageSelection.value = val;
            // clear previous visual markers
            document.querySelectorAll('.img-wrap').forEach(w => w.classList.remove('border-primary', 'shadow'));
            if (domEl) {
                domEl.classList.add('border-primary', 'shadow');
            }
        }

        function renderPreviews() {
            imagePreview.innerHTML = '';
            // render existing images first
            existingImages.forEach((img, idx) => {
                // container is a horizontal flex row: image (with badge overlay) then delete button to the right
                const wrap = document.createElement('div');
                wrap.className = 'd-flex align-items-center gap-2 me-2 mb-2 p-1 rounded border';
                wrap.style.cursor = 'pointer';
                wrap.dataset.value = 'existing:' + img.id;

                // image container so badge can be absolute relative to image
                const imgContainer = document.createElement('div');
                imgContainer.style.position = 'relative';
                const el = document.createElement('img');
                el.src = img.url;
                el.style.maxWidth = '80px';
                el.style.maxHeight = '80px';
                el.className = 'd-block';
                imgContainer.appendChild(el);

                // badge for title (overlay on image)
                if (img.titleImage) {
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-primary position-absolute';
                    badge.style.left = '6px';
                    badge.style.top = '6px';
                    badge.textContent = 'Title';
                    imgContainer.appendChild(badge);
                }

                wrap.appendChild(imgContainer);

                // delete button placed to the right (outside the image)
                const del = document.createElement('button');
                del.type = 'button';
                del.className = 'btn btn-sm btn-danger';
                del.style.padding = '0.15rem 0.35rem';
                del.style.lineHeight = '1';
                del.textContent = '×';
                del.title = 'Remove image';
                del.addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    // mark for deletion and remove from UI
                    imagesToDelete.push(img.id);
                    // if this was selected as title, clear selection
                    if (selectedValue === wrap.dataset.value) {
                        selectedValue = null;
                        titleImageSelection.value = '';
                    }
                    wrap.remove();
                });

                wrap.addEventListener('click', () => setSelectedValue(wrap.dataset.value, wrap));
                wrap.appendChild(del);
                imagePreview.appendChild(wrap);

                // if this should be selected initially
                if ((selectedValue && selectedValue === wrap.dataset.value) || (!selectedValue && img.titleImage)) {
                    setSelectedValue(wrap.dataset.value, wrap);
                }
            });

            // render newly selected files
            const files = Array.from(imagesInput.files || []);
            files.forEach((file, idx) => {
                if (deletedNewIndices.has(idx)) return;
                const wrap = document.createElement('div');
                wrap.className = 'd-flex align-items-center gap-2 me-2 mb-2 p-1 rounded border';
                wrap.style.cursor = 'pointer';
                wrap.dataset.value = 'new:' + idx;

                const el = document.createElement('img');
                el.style.maxWidth = '80px';
                el.style.maxHeight = '80px';
                el.className = 'd-block';

                const reader = new FileReader();
                reader.onload = function(e) {
                    el.src = e.target.result;
                };
                reader.readAsDataURL(file);

                // delete button for newly selected file (remove from view and mark index skipped)
                const del = document.createElement('button');
                del.type = 'button';
                del.className = 'btn btn-sm btn-danger';
                del.style.padding = '0.15rem 0.35rem';
                del.style.lineHeight = '1';
                del.textContent = '×';
                del.title = 'Remove new image';
                del.addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    // mark new index as deleted so it won't be sent
                    deletedNewIndices.add(idx);
                    // if this was selected, clear selection
                    if (selectedValue === wrap.dataset.value) {
                        selectedValue = null;
                        titleImageSelection.value = '';
                    }
                    renderPreviews();
                });

                wrap.appendChild(el);
                wrap.appendChild(del);
                wrap.addEventListener('click', () => setSelectedValue(wrap.dataset.value, wrap));
                imagePreview.appendChild(wrap);
                // if matches previously selected value
                if (selectedValue && selectedValue === wrap.dataset.value) setSelectedValue(wrap.dataset.value, wrap);
            });
        }

        imagesInput.addEventListener('change', () => {
            // re-render previews to include files
            renderPreviews();
        });

        resetBtn.onclick = function() {
            productForm.reset();
            document.getElementById('productId').value = '';
            // clear preview and selection state
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('titleImageSelection').value = '';
            existingImages = [];
            selectedValue = null;
            // clear file input
            const imagesInput = document.getElementById('images');
            if (imagesInput) imagesInput.value = null;
        };

        filterCompanySelect.onchange = function() {
            fetchProducts(this.value);
        };

        window.editProduct = function(id) {
        	//alert('apdfasd: '+apiUrl);
        	//alert('m: '+method);
            fetch(`${apiUrl}/${id}`)
                .then(res => res.json())
                .then(product => {
                    document.getElementById('productId').value = product.id;
                    document.getElementById('name').value = product.name;
                    document.getElementById('description').value = product.description;
                    document.getElementById('price').value = product.price;
                    document.getElementById('companyId').value = product.company ? product.company.id : '';
                    document.getElementById('productTypeId').value = product.productType ? product.productType.id : '';
                    document.getElementById('productCategoryId').value = product.productCategory ? product.productCategory.id : '';
					//alert("on edit product images length: "+product.images.length);
                    // Show existing images in preview and select
                    const imagePreview = document.getElementById('imagePreview');
                   // const titleImageSelect = document.getElementById('titleImageSelect');
                  // alert(imagePreview);
                   //alert(titleImageSelect);
                    imagePreview.innerHTML = '';
                    existingImages = product.images && product.images.length > 0 ? product.images : [];
                    // clear any previous file input selection
                    imagesInput.value = null;
                    selectedValue = null;
                    titleImageSelection.value = '';
                    imagesToDelete = [];
                    deletedNewIndices.clear();
                    renderPreviews();
                   // keep user selection state
                });
        };

        window.deleteProduct = function(id) {
            fetch(`${apiUrl}/${id}`, { method: 'DELETE' })
                .then(() => fetchProducts(filterCompanySelect.value));
        };

        fetchCompanies();
        fetchProductTypes();
        fetchProductCategories();
        fetchProducts();
    </script>
</body>
</html>
