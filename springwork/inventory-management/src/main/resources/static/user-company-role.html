<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Company Roles</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light min-vh-100">
    <div class="container py-5 px-2">
        <h1 class="display-5 fw-bold mb-4 text-center">User Company Roles</h1>
        <div class="card mb-4">
            <div class="card-body">
                <form id="ucrForm" class="row g-3 w-100 mx-auto">
                    <input type="hidden" id="ucrId">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold" for="userId">User</label>
                        <select id="userId" class="form-select"></select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold" for="companyId">Company</label>
                        <select id="companyId" class="form-select"></select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold" for="roleId">Role</label>
                        <select id="roleId" class="form-select"></select>
                    </div>
                    <div class="col-12 d-flex justify-content-end gap-2 mt-2">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" id="resetBtn" class="btn btn-secondary">Reset</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <h2 class="h5 fw-bold mb-3">Mappings</h2>
                <div class="table-responsive">
                    <table class="table table-bordered table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>User</th>
                                <th>Company</th>
                                <th>Role</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="mappingsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script>
        const apiUrl = '/user-company-roles';
        const usersApi = '/users';
        const companiesApi = '/companies';
        const rolesApi = '/roles';
        const ucrForm = document.getElementById('ucrForm');
        const mappingsTable = document.getElementById('mappingsTable');

        function loadSelects() {
            fetch(usersApi).then(res => res.json()).then(users => { 
                const sel = document.getElementById('userId'); sel.innerHTML = '<option value="">Select user</option>';
                users.forEach(u=> sel.innerHTML += `<option value="${u.id}">${u.username} (${u.loginName||''})</option>`);
            });
            fetch(companiesApi).then(res => res.json()).then(c=>{ const sel = document.getElementById('companyId'); sel.innerHTML = '<option value="">Select company</option>'; c.forEach(x=> sel.innerHTML += `<option value="${x.id}">${x.name}</option>`); });
            fetch(rolesApi).then(res => res.json()).then(r=>{ const sel = document.getElementById('roleId'); sel.innerHTML = '<option value="">Select role</option>'; r.forEach(x=> sel.innerHTML += `<option value="${x.id}">${x.name}</option>`); });
        }

        function loadMappings() {
            fetch(apiUrl).then(res => res.json()).then(m => {
                mappingsTable.innerHTML = '';
                m.forEach(mm => {
                    mappingsTable.innerHTML += `
                        <tr>
                            <td>${mm.id}</td>
                            <td>${mm.user ? mm.user.username : ''}</td>
                            <td>${mm.company ? mm.company.name : ''}</td>
                            <td>${mm.role ? mm.role.name : ''}</td>
                            <td class="d-flex gap-2">
                                <button class="btn btn-warning btn-sm text-white" onclick="editMapping(${mm.id})">Edit</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteMapping(${mm.id})">Delete</button>
                            </td>
                        </tr>
                    `;
                });
            });
        }

        ucrForm.onsubmit = function(e) {
            e.preventDefault();
            const id = document.getElementById('ucrId').value;
            const userId = document.getElementById('userId').value;
            const companyId = document.getElementById('companyId').value;
            const roleId = document.getElementById('roleId').value;
            if (!userId || !companyId || !roleId) return alert('Select user, company and role');
            const payload = { userId: parseInt(userId), companyId: parseInt(companyId), roleId: parseInt(roleId) };
            let method = 'POST';
            let url = apiUrl;
            if (id) { method = 'PUT'; url += `/${id}`; }
            fetch(url, { method, headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) })
                .then(async res => { if (!res.ok) { const msg = await res.text(); alert(msg || 'Error'); throw new Error(msg); } return res.json();})
                .then(() => { ucrForm.reset(); document.getElementById('ucrId').value = ''; loadMappings(); })
                .catch(()=>{});
        }

        window.editMapping = function(id) { fetch(`${apiUrl}/${id}`).then(res => res.json()).then(m => { document.getElementById('ucrId').value = m.id; document.getElementById('userId').value = m.user ? m.user.id : ''; document.getElementById('companyId').value = m.company ? m.company.id : ''; document.getElementById('roleId').value = m.role ? m.role.id : ''; }); };
        window.deleteMapping = function(id) { if (!confirm('Delete role assignment?')) return; fetch(`${apiUrl}/${id}`, {method:'DELETE'}).then(() => loadMappings()); };

        function reset() { ucrForm.reset(); document.getElementById('ucrId').value = ''; }
        document.getElementById('resetBtn').onclick = reset;

        loadSelects();
        loadMappings();
    </script>
</body>
</html>